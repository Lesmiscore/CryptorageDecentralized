def pathEnv = "$buildDir/node/bin:$System.env.PATH"

task installBinariesIfNeeded(type: Exec) {
    workingDir buildDir
    commandLine "bash", "-c", """
mkdir node/ || true
cd node/
if type truffle && type web3j ; then
  echo OK > ok
  exit 0
fi
wget -qO- https://nodejs.org/dist/v10.5.0/node-v10.5.0-linux-x64.tar.xz | tar -xJf - --strip-components=1
./bin/node ./bin/npm i -g truffle solc
wget -qO- https://github.com/web3j/web3j/releases/download/v3.4.0/web3j-3.4.0.tar | tar -xf - --strip-components=1
"""
    inputs.files "./build/node/"
    outputs.files "./build/node/"
}

task truffleCompile(type: Exec) {
    dependsOn installBinariesIfNeeded
    workingDir "./contract"
    commandLine "env", "truffle", "compile"
    environment "PATH": pathEnv
    inputs.files "./contract/contracts"
    outputs.files "./contracts/build"
}

task web3jContractWrapper(type: Exec) {
    dependsOn "truffleCompile"
    workingDir "."
    commandLine "env", "web3j", "truffle", "generate", "./contract/build/contracts/FileSourceContract.json", "-o", "./src/solidity", "-p", "com.nao20010128nao.Cryptorage.internal.contract"
    environment "PATH": pathEnv
    inputs.files "./contract/build"
    outputs.files "./src/solidity"
}

compileKotlin.dependsOn "web3jContractWrapper"
